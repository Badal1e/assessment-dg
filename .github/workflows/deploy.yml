name: Deploy - Update Lambda From ECR Image

on:
  workflow_run:
    workflows:
      - "CI - Build & Push Lambda Image"
    types:
      - completed

env:
  AWS_REGION: ap-south-1                   
  AWS_ACCOUNT_ID: 502497380721            
  ECR_REPOSITORY: datagrokr-intern-devops          
  LAMBDA_FUNCTION_NAME: EventMonitoringContainerFunction  

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-1

      - name: Determine image URI
        id: image_uri
        run: |
          COMMIT_SHA="${{ github.event.workflow_run.head_sha }}"
          IMAGE_URI="$AWS_ACCOUNT_ID.dkr.ecr.$AWS_REGION.amazonaws.com/$ECR_REPOSITORY:$COMMIT_SHA"

          echo "Using image URI: $IMAGE_URI"
          echo "image_uri=$IMAGE_URI" >> "$GITHUB_OUTPUT"

      - name: Update Lambda function code
        run: |
          aws lambda update-function-code --function-name "$LAMBDA_FUNCTION_NAME" --image-uri "${{ steps.image_uri.outputs.image_uri }}" --region "$AWS_REGION"

      - name: Wait for Lambda to be updated
        run: |
          aws lambda wait function-updated --function-name "$LAMBDA_FUNCTION_NAME" --region "$AWS_REGION"

      - name: Invoke Lambda for verification
        id: invoke
        run: |

          echo "Lambda response:"
          cat response.json
          
      - name: Basic response check
        run: |
          if [ ! -s response.json ]; then
            echo "Error: Empty Lambda response. Failing deployment."
            exit 1
          fi

          echo "Deployment verification passed."
